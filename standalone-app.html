<!DOCTYPE html>
<html lang="en-IN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Naga & Sandeep</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-yellow': { DEFAULT: '#FBBF24' }
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
        .hidden { display: none !important; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; color: white; font-size: 0.875rem; }
        .calendar-day:hover:not(.disabled) { background-color: #374151; }
        .calendar-day.selected { background-color: #FBBF24; color: #111827; font-weight: bold; }
        .calendar-day.today { border: 2px solid #FBBF24; }
        .calendar-day.disabled { opacity: 0.3; cursor: not-allowed; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; margin-bottom: 0.5rem; }
        .calendar-header-day { text-align: center; font-size: 0.875rem; font-weight: 600; color: #FBBF24; padding: 0.5rem 0; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #qrcode { display: flex; justify-content: center; align-items: center; }
        #qrcode canvas { display: block; margin: 0 auto; }
        #qrcode img { display: block; margin: 0 auto; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="app"></div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBxC8fQ_demo_key_replace_with_yours",
            authDomain: "expense-tracker-demo.firebaseapp.com",
            databaseURL: "https://expense-tracker-demo-default-rtdb.firebaseio.com",
            projectId: "expense-tracker-demo",
            storageBucket: "expense-tracker-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:demo"
        };

        // Initialize Firebase
        let database;
        let isFirebaseEnabled = false;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isFirebaseEnabled = true;
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.warn('Firebase not available, using localStorage only:', error);
            isFirebaseEnabled = false;
        }

        // ===== STATE MANAGEMENT =====
        const AppState = {
            walletBalance: 94,
            expenses: [],
            isAdmin: false,
            currentPage: 'user',
            selectedDate: new Date(),
            isLoading: false,

            init() {
                // First load from localStorage for instant display
                const saved = localStorage.getItem('walletBalance');
                if (saved !== null) this.walletBalance = parseFloat(saved);
                
                const savedExpenses = localStorage.getItem('expenses');
                if (savedExpenses) {
                    this.expenses = JSON.parse(savedExpenses, (k, v) => {
                        if (k === 'createdAt') return new Date(v);
                        return v;
                    });
                }

                // Then sync with Firebase if available
                if (isFirebaseEnabled) {
                    this.syncFromFirebase();
                }
            },

            syncFromFirebase() {
                // Listen for wallet balance changes
                database.ref('walletBalance').on('value', (snapshot) => {
                    const value = snapshot.val();
                    if (value !== null && value !== this.walletBalance) {
                        this.walletBalance = value;
                        localStorage.setItem('walletBalance', value);
                        if (!this.isLoading) render();
                    }
                });

                // Listen for expenses changes
                database.ref('expenses').on('value', (snapshot) => {
                    const value = snapshot.val();
                    if (value) {
                        this.expenses = Object.values(value).map(exp => ({
                            ...exp,
                            createdAt: new Date(exp.createdAt)
                        }));
                        localStorage.setItem('expenses', JSON.stringify(this.expenses));
                        if (!this.isLoading) render();
                    }
                });
            },

            save() {
                // Save to localStorage
                localStorage.setItem('walletBalance', this.walletBalance);
                localStorage.setItem('expenses', JSON.stringify(this.expenses));
                
                // Save to Firebase if available
                if (isFirebaseEnabled) {
                    this.isLoading = true;
                    database.ref('walletBalance').set(this.walletBalance);
                    
                    const expensesObj = {};
                    this.expenses.forEach(exp => {
                        expensesObj[exp.id] = {
                            ...exp,
                            createdAt: exp.createdAt.toISOString()
                        };
                    });
                    database.ref('expenses').set(expensesObj).then(() => {
                        this.isLoading = false;
                    });
                } else {
                    // Trigger storage event for cross-tab sync (same device)
                    window.dispatchEvent(new Event('storage'));
                }
            },

            addExpense(item, amount, message = '') {
                const expense = {
                    id: Date.now() + Math.random(),
                    createdAt: new Date(),
                    item,
                    amount: parseFloat(amount),
                    message
                };
                this.expenses.unshift(expense);
                this.walletBalance -= expense.amount;
                this.save();
                render();
            },

            addBalance(amount) {
                const credit = {
                    id: Date.now() + Math.random(),
                    createdAt: new Date(),
                    item: 'Balance Added',
                    amount: parseFloat(amount),
                    message: 'Credited by Admin'
                };
                this.expenses.unshift(credit);
                this.walletBalance += credit.amount;
                this.save();
                render();
            },

            deleteExpense(id) {
                const expense = this.expenses.find(e => e.id === id);
                if (!expense) return;
                
                if (expense.item === 'Balance Added') {
                    this.walletBalance -= expense.amount;
                } else {
                    this.walletBalance += expense.amount;
                }
                
                this.expenses = this.expenses.filter(e => e.id !== id);
                this.save();
                render();
            },

            login(username, password) {
                if (username === 'sandeep' && password === 'Adithi@2013') {
                    this.isAdmin = true;
                    this.currentPage = 'admin';
                    render();
                    return true;
                }
                return false;
            },

            logout() {
                this.isAdmin = false;
                this.currentPage = 'login';
                render();
            },

            navigate(page) {
                if (page === 'admin' && !this.isAdmin) {
                    this.currentPage = 'login';
                } else {
                    this.currentPage = page;
                }
                render();
            }
        };

        // ===== UTILITY FUNCTIONS =====
        function formatDate(date, format) {
            const d = new Date(date);
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            
            const pad = (n) => String(n).padStart(2, '0');
            const ordinal = (n) => {
                if (n > 3 && n < 21) return n + 'th';
                switch (n % 10) {
                    case 1: return n + 'st';
                    case 2: return n + 'nd';
                    case 3: return n + 'rd';
                    default: return n + 'th';
                }
            };
            
            return format
                .replace('EEEE', days[d.getDay()])
                .replace('MMMM', months[d.getMonth()])
                .replace('MMM', months[d.getMonth()].slice(0,3))
                .replace('do', ordinal(d.getDate()))
                .replace('dd', pad(d.getDate()))
                .replace('MM', pad(d.getMonth() + 1))
                .replace('yyyy', d.getFullYear())
                .replace('yy', String(d.getFullYear()).slice(2))
                .replace('HH', pad(d.getHours()))
                .replace('mm', pad(d.getMinutes()))
                .replace('ss', pad(d.getSeconds()))
                .replace('p', d.getHours() >= 12 ? 'PM' : 'AM');
        }

        function isSameDay(d1, d2) {
            const date1 = new Date(d1);
            const date2 = new Date(d2);
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function isToday(date) {
            return isSameDay(date, new Date());
        }

        // ===== ICONS (SVG) =====
        const Icons = {
            Wallet: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>',
            Calendar: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>',
            PlusCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>',
            ShoppingCart: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>',
            MessageSquare: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
            IndianRupee: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12"/><path d="M6 8h12"/><path d="m6 13 8.5 8"/><path d="M6 13h3"/><path d="M9 13c6.667 0 6.667-10 0-10"/></svg>',
            UserCog: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="15" r="3"/><circle cx="9" cy="7" r="4"/><path d="M10 15H6a4 4 0 0 0-4 4v2"/><path d="m21.7 16.4-.9-.3"/><path d="m15.2 13.9-.9-.3"/><path d="m16.6 18.7.3-.9"/><path d="m19.1 12.2.3-.9"/><path d="m19.6 18.7-.4-1"/><path d="m16.8 12.3-.4-1"/><path d="m14.3 16.6 1-.4"/><path d="m20.7 13.8 1-.4"/></svg>',
            LogOut: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>',
            Download: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',
            QrCode: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>',
            Trash2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>',
            Lock: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
            X: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
            Smartphone: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>'
        };

        function icon(name, className = 'w-5 h-5') {
            return `<span class="inline-block ${className}">${Icons[name]}</span>`;
        }

        // ===== CALENDAR COMPONENT =====
        function renderCalendar() {
            const selected = AppState.selectedDate;
            const year = selected.getFullYear();
            const month = selected.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            let html = `
                <div class="calendar-header">
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => 
                        `<div class="calendar-header-day">${d}</div>`
                    ).join('')}
                </div>
                <div class="calendar">`;
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isSelected = isSameDay(date, selected);
                const isTodayDate = isSameDay(date, today);
                const isFuture = date > today;
                const classes = ['calendar-day'];
                if (isSelected) classes.push('selected');
                if (isTodayDate) classes.push('today');
                if (isFuture) classes.push('disabled');
                
                html += `<div class="${classes.join(' ')}" onclick="${isFuture ? '' : `selectDate(${year},${month},${day})`}">${day}</div>`;
            }
            
            html += '</div>';
            return html;
        }

        function selectDate(year, month, day) {
            AppState.selectedDate = new Date(year, month, day);
            render();
        }

        // ===== USER PAGE =====
        function renderUserPage() {
            const dailyExpenses = AppState.expenses.filter(e => 
                isSameDay(e.createdAt, AppState.selectedDate) && e.item !== 'Balance Added'
            );
            const totalSpentToday = dailyExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            return `
                <div class="min-h-screen bg-gray-900 text-white p-4 sm:p-6 lg:p-8">
                    <div class="max-w-4xl mx-auto">
                        <header class="mb-8 flex justify-between items-start">
                            <div>
                                <h1 class="text-3xl font-bold text-brand-yellow">Hi Naga,</h1>
                                <p class="text-gray-400">Here's your expense summary.</p>
                            </div>
                            <button onclick="AppState.navigate('admin')" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm sm:text-base">
                                ${icon('UserCog')}
                                <span>Admin Panel</span>
                            </button>
                        </header>

                        <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 mb-6">
                            <div class="p-4 sm:p-6 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    ${icon('Wallet', 'w-8 h-8 text-brand-yellow')}
                                    <span class="text-lg text-gray-300">Current Wallet Balance:</span>
                                </div>
                                <span class="text-2xl font-bold text-white">₹${AppState.walletBalance.toFixed(2)}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                                    <div class="p-4 sm:p-6 border-b border-gray-700">
                                        <h3 class="text-lg font-semibold text-gray-100">Add New Expense</h3>
                                    </div>
                                    <div class="p-4 sm:p-6">
                                        <form onsubmit="handleAddExpense(event)" class="space-y-4">
                                            <div class="relative">
                                                ${icon('ShoppingCart', 'absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400')}
                                                <input type="text" id="item" placeholder="Item Purchased" class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2 pl-10 focus:ring-brand-yellow focus:border-brand-yellow" required />
                                            </div>
                                            <div class="relative">
                                                ${icon('IndianRupee', 'absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400')}
                                                <input type="number" id="amount" step="0.01" placeholder="Amount Spent" class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2 pl-10 focus:ring-brand-yellow focus:border-brand-yellow" required />
                                            </div>
                                            <div class="relative">
                                                ${icon('MessageSquare', 'absolute left-3 top-3 w-5 h-5 text-gray-400')}
                                                <textarea id="message" placeholder="Message (Optional)" class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2 pl-10 h-24 resize-none focus:ring-brand-yellow focus:border-brand-yellow"></textarea>
                                            </div>
                                            <button type="submit" class="w-full flex items-center justify-center bg-brand-yellow text-gray-900 font-bold py-2.5 px-4 rounded-md hover:bg-brand-yellow/90 transition-colors">
                                                ${icon('PlusCircle')}
                                                <span class="ml-2">Submit Expense</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                                    <div class="p-4 sm:p-6 border-b border-gray-700">
                                        <h3 class="text-lg font-semibold text-gray-100">Daily Expense Summary (${formatDate(AppState.selectedDate, 'do MMMM')})</h3>
                                    </div>
                                    <div class="p-4 sm:p-6 space-y-3">
                                        <div class="flex justify-between items-center text-lg">
                                            <span class="text-gray-300">Total Spent Today:</span>
                                            <span class="font-semibold text-red-400">- ₹${totalSpentToday.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-lg">
                                            <span class="text-gray-300">Remaining Balance:</span>
                                            <span class="font-semibold text-green-400">₹${AppState.walletBalance.toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row-start-1 lg:row-auto">
                                <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                                    <div class="p-4 sm:p-6 border-b border-gray-700 flex items-center space-x-2">
                                        ${icon('Calendar', 'w-5 h-5 text-brand-yellow')}
                                        <h3 class="text-lg font-semibold text-gray-100">Select Date</h3>
                                    </div>
                                    <div class="p-4 sm:p-6">
                                        ${renderCalendar()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleAddExpense(e) {
            e.preventDefault();
            const item = document.getElementById('item').value;
            const amount = document.getElementById('amount').value;
            const message = document.getElementById('message').value;
            AppState.addExpense(item, amount, message);
        }

        // ===== ADMIN PAGE =====
        function renderAdminPage() {
            const transactions = AppState.expenses.map((exp, idx) => {
                let runningBalance = AppState.walletBalance;
                for (let i = 0; i < idx; i++) {
                    const e = AppState.expenses[i];
                    if (e.item === 'Balance Added') runningBalance -= e.amount;
                    else runningBalance += e.amount;
                }
                return {
                    ...exp,
                    type: exp.item === 'Balance Added' ? 'credit' : 'expense',
                    runningBalance
                };
            });

            const expensesByDate = {};
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    const dateStr = formatDate(t.createdAt, 'yyyy-MM-dd');
                    expensesByDate[dateStr] = (expensesByDate[dateStr] || 0) + t.amount;
                }
            });

            let transactionRows = '';
            let lastDate = '';
            transactions.forEach((t, idx) => {
                const dateStr = formatDate(t.createdAt, 'yyyy-MM-dd');
                if (dateStr !== lastDate) {
                    transactionRows += `
                        <tr class="bg-gray-700/50">
                            <td colspan="4" class="px-4 py-2 font-bold text-brand-yellow">${formatDate(t.createdAt, 'EEEE, do MMMM yyyy')}</td>
                            <td colspan="2" class="px-4 py-2 font-bold text-red-400 text-right">Total Spent: ₹${(expensesByDate[dateStr] || 0).toFixed(2)}</td>
                        </tr>`;
                    lastDate = dateStr;
                }
                transactionRows += `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="px-4 py-3">${formatDate(t.createdAt, 'dd/MM/yy')}</td>
                        <td class="px-4 py-3">${formatDate(t.createdAt, 'HH:mm p')}</td>
                        <td class="px-4 py-3">
                            <p class="font-medium text-white">${t.item}</p>
                            ${t.message ? `<p class="text-gray-400 text-xs">${t.message}</p>` : ''}
                        </td>
                        <td class="px-4 py-3 text-right font-semibold ${t.type === 'credit' ? 'text-green-400' : 'text-red-400'}">
                            ${t.type === 'credit' ? '+' : '-'} ₹${t.amount.toFixed(2)}
                        </td>
                        <td class="px-4 py-3 text-right">₹${t.runningBalance.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="handleDeleteExpense('${t.id}')" class="text-gray-400 hover:text-red-500 transition-colors">
                                ${icon('Trash2', 'w-4 h-4')}
                            </button>
                        </td>
                    </tr>`;
            });

            return `
                <div class="min-h-screen bg-gray-900 text-white p-4 sm:p-6 lg:p-8">
                    <div class="max-w-7xl mx-auto">
                        <header class="mb-8 flex justify-between items-center">
                            <div>
                                <h1 class="text-3xl font-bold text-brand-yellow">Admin Dashboard</h1>
                                <p class="text-gray-400">Welcome, Sandeep.</p>
                            </div>
                            <button onclick="AppState.logout()" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                                ${icon('LogOut')}
                                <span>Logout</span>
                            </button>
                        </header>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 lg:col-span-1">
                                <div class="p-4 sm:p-6 flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        ${icon('Wallet', 'w-8 h-8 text-brand-yellow')}
                                        <span class="text-lg text-gray-300">Current Wallet Balance:</span>
                                    </div>
                                    <span class="text-2xl font-bold text-white">₹${AppState.walletBalance.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 lg:col-span-2">
                                <div class="p-4 sm:p-6 border-b border-gray-700">
                                    <h3 class="text-lg font-semibold text-gray-100">Add Balance / Pay</h3>
                                </div>
                                <div class="p-4 sm:p-6">
                                    <form onsubmit="handleAddBalance(event)" class="flex flex-col sm:flex-row gap-4">
                                        <div class="relative flex-grow">
                                            ${icon('IndianRupee', 'absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400')}
                                            <input type="number" id="balanceAmount" step="0.01" placeholder="Enter Amount" class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2.5 pl-10 focus:ring-brand-yellow focus:border-brand-yellow" required />
                                        </div>
                                        <div class="flex gap-4">
                                            <button type="submit" class="flex-1 flex items-center justify-center bg-brand-yellow text-gray-900 font-bold py-2.5 px-4 rounded-md hover:bg-brand-yellow/90 transition-colors">
                                                ${icon('PlusCircle')}
                                                <span class="ml-2">Add</span>
                                            </button>
                                            <button type="button" onclick="handlePayClick()" class="flex-1 flex items-center justify-center bg-purple-600 text-white font-bold py-2.5 px-4 rounded-md hover:bg-purple-700 transition-colors">
                                                ${icon('QrCode')}
                                                <span class="ml-2">Pay</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                            <div class="p-4 sm:p-6 border-b border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                <h3 class="text-lg font-semibold text-gray-100">Expense History</h3>
                                <button onclick="exportCSV()" class="mt-2 sm:mt-0 flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm">
                                    ${icon('Download', 'w-4 h-4')}
                                    <span>Export CSV</span>
                                </button>
                            </div>
                            <div class="p-4 sm:p-6">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm text-gray-300">
                                        <thead class="bg-gray-700 text-xs text-gray-200 uppercase">
                                            <tr>
                                                <th class="px-4 py-3">Date</th>
                                                <th class="px-4 py-3">Time</th>
                                                <th class="px-4 py-3">Item/Details</th>
                                                <th class="px-4 py-3 text-right">Amount</th>
                                                <th class="px-4 py-3 text-right">Remaining Bal.</th>
                                                <th class="px-4 py-3 text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${transactions.length === 0 ? 
                                                '<tr><td colspan="6" class="text-center py-8 text-gray-400">No transactions yet.</td></tr>' : 
                                                transactionRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleAddBalance(e) {
            e.preventDefault();
            const amount = document.getElementById('balanceAmount').value;
            if (amount && parseFloat(amount) > 0) {
                AppState.addBalance(amount);
            }
        }

        function handleDeleteExpense(id) {
            if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                AppState.deleteExpense(id);
            }
        }

        function handlePayClick() {
            const amount = document.getElementById('balanceAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid amount to pay.');
                return;
            }
            showQRModal(parseFloat(amount));
        }

        function exportCSV() {
            const transactions = AppState.expenses.map(exp => ({
                Date: formatDate(exp.createdAt, 'yyyy-MM-dd'),
                Time: formatDate(exp.createdAt, 'HH:mm:ss'),
                Item: exp.item,
                Amount: exp.amount,
                Type: exp.item === 'Balance Added' ? 'credit' : 'expense',
                Message: exp.message || '',
            }));
            
            const csv = Papa.unparse(transactions);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `expense_history_${formatDate(new Date(), 'yyyy-MM-dd')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ===== LOGIN PAGE =====
        function renderLoginPage() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gray-900 p-4">
                    <div class="w-full max-w-sm bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                        <div class="p-4 sm:p-6 border-b border-gray-700 text-center">
                            <div class="flex justify-center mb-4">
                                <div class="bg-brand-yellow/10 p-3 rounded-full">
                                    ${icon('Lock', 'w-8 h-8 text-brand-yellow')}
                                </div>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-100">Admin Login</h3>
                        </div>
                        <div class="p-4 sm:p-6">
                            <form onsubmit="handleLogin(event)" class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-400" for="username">Username</label>
                                    <input id="username" type="text" class="mt-1 w-full bg-gray-700 border-gray-600 text-white rounded-md p-2 focus:ring-brand-yellow focus:border-brand-yellow" required />
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-400" for="password">Password</label>
                                    <input id="password" type="password" class="mt-1 w-full bg-gray-700 border-gray-600 text-white rounded-md p-2 focus:ring-brand-yellow focus:border-brand-yellow" required />
                                </div>
                                <p id="loginError" class="text-red-500 text-sm hidden"></p>
                                <button type="submit" class="w-full bg-brand-yellow text-gray-900 font-bold py-2 px-4 rounded-md hover:bg-brand-yellow/90 transition-colors">
                                    Login
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const success = AppState.login(username, password);
            if (!success) {
                const errorEl = document.getElementById('loginError');
                errorEl.textContent = 'Invalid username or password.';
                errorEl.classList.remove('hidden');
            }
        }

        // ===== QR CODE MODAL =====
        function showQRModal(amount) {
            const upiUrl = `upi://pay?pa=7337772694@ybl&pn=Sandeep&am=${amount}&cu=INR`;
            const isMobile = /Mobi|Android/i.test(navigator.userAgent);
            
            const modalHtml = `
                <div id="qrModal" class="modal" onclick="closeQRModal(event)">
                    <div class="w-full max-w-sm bg-gray-800 rounded-xl shadow-lg border border-gray-700 relative" onclick="event.stopPropagation()">
                        <button onclick="closeQRModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors">
                            ${icon('X', 'w-6 h-6')}
                        </button>
                        <div class="p-4 sm:p-6 border-b border-gray-700 text-center">
                            <h3 class="text-lg font-semibold text-brand-yellow">${isMobile ? 'Mobile Payment' : 'Scan to Pay'}</h3>
                            ${isMobile ? `<p class="text-gray-300 mt-1">You are about to pay</p>` : ''}
                            <p class="text-3xl font-bold text-white mt-2">₹${amount.toFixed(2)}</p>
                        </div>
                        <div class="p-4 sm:p-6 flex flex-col items-center justify-center space-y-4">
                            ${isMobile ? `
                                <a href="${upiUrl}" class="w-full flex items-center justify-center bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition-colors text-lg">
                                    ${icon('Smartphone', 'w-6 h-6 mr-3')}
                                    Pay with UPI App
                                </a>
                                <p class="text-gray-400 text-sm">or</p>
                            ` : ''}
                            <div class="p-4 bg-white rounded-lg">
                                <div id="qrcode"></div>
                            </div>
                            <p class="text-xs text-gray-400 text-center px-4 mt-2">
                                UPI ID: <span class="font-mono text-brand-yellow">7337772694@ybl</span>
                            </p>
                            <p class="text-xs text-gray-500 text-center px-4">
                                ${isMobile ? 'Scan with another device or UPI app.' : 'Scan with any UPI app to pay'}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Generate QR code after a small delay to ensure DOM is ready
            setTimeout(function() {
                const qrcodeElement = document.getElementById('qrcode');
                if (qrcodeElement) {
                    // Clear any existing QR code
                    qrcodeElement.innerHTML = '';
                    new QRCode(qrcodeElement, {
                        text: upiUrl,
                        width: 200,
                        height: 200,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }, 100);
        }

        function closeQRModal(event) {
            if (!event || event.target.id === 'qrModal') {
                const modal = document.getElementById('qrModal');
                if (modal) modal.remove();
            }
        }

        // ===== MAIN RENDER FUNCTION =====
        function render() {
            const app = document.getElementById('app');
            let content = '';
            
            switch (AppState.currentPage) {
                case 'user':
                    content = renderUserPage();
                    break;
                case 'admin':
                    content = renderAdminPage();
                    break;
                case 'login':
                    content = renderLoginPage();
                    break;
                default:
                    content = renderUserPage();
            }
            
            app.innerHTML = content;
        }

        // ===== CROSS-TAB SYNC (for same device without Firebase) =====
        if (!isFirebaseEnabled) {
            window.addEventListener('storage', function(e) {
                // Reload data when localStorage changes in another tab
                AppState.init();
                render();
            });
        }

        // ===== INITIALIZATION =====
        AppState.init();
        render();
    </script>
</body>
</html>